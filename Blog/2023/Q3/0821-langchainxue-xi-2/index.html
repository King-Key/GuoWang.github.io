<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        
            
        

      <title></title>

      
      <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
      <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://king-key.github.io/book.css">
      <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        

      <script>
          document.addEventListener('DOMContentLoaded', function () {
            var menu = document.getElementById('navMenu');
            var toggleButton = document.getElementById('toggleMenu');

            toggleButton.addEventListener('click', function () {
                menu.classList.toggle('active');
            });
        });

      </script>


      
      
    </head>

    <body>
        <div class="menu">
            <div class="card">
                <div class="card-border-top"></div>
                <div class="img"></div>
                <span> Wang Guo</span>
                <p class="job"> <a class="link" href="https://qingkelab.github.io">ÈùíÁ®ûÁ§æÂå∫</a>ÂàõÂßã‰∫∫ </p>
                <center><img src="https://img.shields.io/badge/MBTIÊÄßÊ†ºÁ±ªÂûã-INTJ(Áã¨Á´ãËá™‰∏ªÁöÑ‰∏ìÂÆ∂)-blue" width="70%"></img></center><br>
              
                <div class="radio-inputs">
                        <label>
                            <a class="link"  href="/‰∏ªÈ°µ/">
                            <i class="bi bi-person-rolodex"></i>
                            </a>
                        </label>

                        <label>
                            <a cla  ss="link" href="https://github.com/King-Key">
                            <i class="bi-github"></i>
                            </a>
                        </label>

                        <label>
                            <a class="link"  href="https://blog.csdn.net/King_key?type=blog">
                            <i class="bi bi-body-text"></i>
                            </a>
                        </label>

                        <label>
                            <a class="link"  href="https://twitter.com/KingKey113">
                            <i class="bi bi-twitter"></i>
                            </a>
                        </label>

                </div><br>
            


              <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://king-key.github.io/‰∏ªÈ°µ/">
                                    
                                    <!--  -->
                                    <i class="bi bi-bookmarks"></i>
                                    About

                                </a>
                                
                            <!-- </li><hr align=center color=#8b8b8b8 size=4> -->
                        
                            
                            <li >
                                
                                <a href="https://king-key.github.io/Blog/">
                                    
                                    <!--  -->
                                    <i class="bi bi-bookmarks"></i>
                                    Blog

                                </a>
                                
                            <!-- </li><hr align=center color=#8b8b8b8 size=4> -->
                        
                            
                            <li >
                                
                                <a href="https://king-key.github.io/ÈöèÁ¨î/">
                                    
                                    <!--  -->
                                    <i class="bi bi-bookmarks"></i>
                                    ÈöèÁ¨î

                                </a>
                                
                            <!-- </li><hr align=center color=#8b8b8b8 size=4> -->
                        
                            
                            <li >
                                
                                <a href="https://king-key.github.io/ÂèãÊÉÖÈìæÊé•/">
                                    
                                    <!--  -->
                                    <i class="bi bi-bookmarks"></i>
                                    links

                                </a>
                                
                            <!-- </li><hr align=center color=#8b8b8b8 size=4> -->
                        
                    
                </ul>
            </nav>

            </div>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">üîé</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>üñã langchainÂ≠¶‰π†2 </h1>
    ‚óè ‚è∞Ô∏é<i> Push timeÔºö2023-08-21 19:08:25</i>
    <hr align=center color=#987cb9 size=4>
    
    <!-- ÂºïÂÖ•ÁõÆÂΩï -->
    <div class="sidebar" id="sidebar">
        <ul id="toc"></ul>
    </div>


    <div class="content">
        <blockquote>
<p>langchain+chatglm2-6b</p>
</blockquote>
<!--more-->
<h2 id="1-langchainzhong-de-zhu-yao-mo-kuai">1„ÄÅlangchain‰∏≠ÁöÑ‰∏ªË¶ÅÊ®°Âùó</h2>
<ul>
<li>Ê®°ÂûãÔºàmodelsÔºâ</li>
<li>ÊèêÁ§∫Ôºàprompts)</li>
<li>ÂÜÖÂ≠òÔºàmemoryÔºâ</li>
<li>Á¥¢ÂºïÔºàindexesÔºâ</li>
<li>ÈìæÔºàchainsÔºâ</li>
<li>‰ª£ÁêÜÔºàagents)</li>
</ul>
<h2 id="2-langchain-chatglm2-6b">2„ÄÅlangchain+chatglm2-6b</h2>
<ul>
<li>Chatglm2-6b apiÔºàÂÆòÊñπ‰ª£Á†ÅÔºâÔºåÂÖà<code> python api.py</code>ËøõË°åËøêË°å</li>
</ul>
<pre data-lang="python" style="background-color:#eff1f5;color:#4f5b66;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">from </span><span>fastapi </span><span style="color:#b48ead;">import </span><span>FastAPI, Request
</span><span style="color:#b48ead;">from </span><span>transformers </span><span style="color:#b48ead;">import </span><span>AutoTokenizer, AutoModel
</span><span style="color:#b48ead;">import </span><span>uvicorn, json, datetime
</span><span style="color:#b48ead;">import </span><span>torch
</span><span>
</span><span style="color:#bf616a;">DEVICE </span><span>= &quot;</span><span style="color:#a3be8c;">cuda</span><span>&quot;
</span><span style="color:#bf616a;">DEVICE_ID </span><span>= &quot;</span><span style="color:#a3be8c;">0</span><span>&quot;
</span><span style="color:#bf616a;">CUDA_DEVICE </span><span>= </span><span style="color:#b48ead;">f</span><span>&quot;{</span><span style="color:#bf616a;">DEVICE</span><span>}</span><span style="color:#a3be8c;">:</span><span>{</span><span style="color:#bf616a;">DEVICE_ID</span><span>}&quot; </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">DEVICE_ID </span><span style="color:#b48ead;">else </span><span style="color:#bf616a;">DEVICE
</span><span>
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">torch_gc</span><span>():
</span><span>    </span><span style="color:#b48ead;">if </span><span>torch.cuda.</span><span style="color:#bf616a;">is_available</span><span>():
</span><span>        </span><span style="color:#b48ead;">with </span><span>torch.cuda.</span><span style="color:#bf616a;">device</span><span>(</span><span style="color:#bf616a;">CUDA_DEVICE</span><span>):
</span><span>            torch.cuda.</span><span style="color:#bf616a;">empty_cache</span><span>()
</span><span>            torch.cuda.</span><span style="color:#bf616a;">ipc_collect</span><span>()
</span><span>
</span><span>
</span><span>app = </span><span style="color:#bf616a;">FastAPI</span><span>()
</span><span>
</span><span>
</span><span>@app.</span><span style="color:#bf616a;">post</span><span>(&quot;</span><span style="color:#a3be8c;">/</span><span>&quot;)
</span><span style="color:#b48ead;">async def </span><span style="color:#8fa1b3;">create_item</span><span>(</span><span style="color:#bf616a;">request</span><span>: Request):
</span><span>    </span><span style="color:#b48ead;">global </span><span>model, tokenizer
</span><span>    json_post_raw = </span><span style="color:#b48ead;">await </span><span>request.</span><span style="color:#bf616a;">json</span><span>()
</span><span>    json_post = json.</span><span style="color:#bf616a;">dumps</span><span>(json_post_raw)
</span><span>    json_post_list = json.</span><span style="color:#bf616a;">loads</span><span>(json_post)
</span><span>    prompt = json_post_list.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">prompt</span><span>&#39;)
</span><span>    history = json_post_list.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">history</span><span>&#39;)
</span><span>    max_length = json_post_list.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">max_length</span><span>&#39;)
</span><span>    top_p = json_post_list.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">top_p</span><span>&#39;)
</span><span>    temperature = json_post_list.</span><span style="color:#bf616a;">get</span><span>(&#39;</span><span style="color:#a3be8c;">temperature</span><span>&#39;)
</span><span>    response, history = model.</span><span style="color:#bf616a;">chat</span><span>(tokenizer,
</span><span>                                   prompt,
</span><span>                                   </span><span style="color:#bf616a;">history</span><span>=history,
</span><span>                                   </span><span style="color:#bf616a;">max_length</span><span>=max_length </span><span style="color:#b48ead;">if </span><span>max_length </span><span style="color:#b48ead;">else </span><span style="color:#d08770;">2048</span><span>,
</span><span>                                   </span><span style="color:#bf616a;">top_p</span><span>=top_p </span><span style="color:#b48ead;">if </span><span>top_p </span><span style="color:#b48ead;">else </span><span style="color:#d08770;">0.7</span><span>,
</span><span>                                   </span><span style="color:#bf616a;">temperature</span><span>=temperature </span><span style="color:#b48ead;">if </span><span>temperature </span><span style="color:#b48ead;">else </span><span style="color:#d08770;">0.95</span><span>)
</span><span>    now = datetime.datetime.</span><span style="color:#bf616a;">now</span><span>()
</span><span>    time = now.</span><span style="color:#bf616a;">strftime</span><span>(&quot;</span><span style="color:#d08770;">%Y</span><span style="color:#a3be8c;">-</span><span style="color:#d08770;">%m</span><span style="color:#a3be8c;">-</span><span style="color:#d08770;">%d %H</span><span style="color:#a3be8c;">:</span><span style="color:#d08770;">%M</span><span style="color:#a3be8c;">:</span><span style="color:#d08770;">%S</span><span>&quot;)
</span><span>    answer = {
</span><span>        &quot;</span><span style="color:#a3be8c;">response</span><span>&quot;: response,
</span><span>        &quot;</span><span style="color:#a3be8c;">history</span><span>&quot;: history,
</span><span>        &quot;</span><span style="color:#a3be8c;">status</span><span>&quot;: </span><span style="color:#d08770;">200</span><span>,
</span><span>        &quot;</span><span style="color:#a3be8c;">time</span><span>&quot;: time
</span><span>    }
</span><span>    log = &quot;</span><span style="color:#a3be8c;">[</span><span>&quot; + time + &quot;</span><span style="color:#a3be8c;">] </span><span>&quot; + &#39;</span><span style="color:#a3be8c;">&quot;, prompt:&quot;</span><span>&#39; + prompt + &#39;</span><span style="color:#a3be8c;">&quot;, response:&quot;</span><span>&#39; + </span><span style="color:#96b5b4;">repr</span><span>(response) + &#39;</span><span style="color:#a3be8c;">&quot;</span><span>&#39;
</span><span>    </span><span style="color:#96b5b4;">print</span><span>(log)
</span><span>    </span><span style="color:#bf616a;">torch_gc</span><span>()
</span><span>    </span><span style="color:#b48ead;">return </span><span>answer
</span><span>
</span><span>
</span><span style="color:#b48ead;">if </span><span>__name__ == &#39;</span><span style="color:#a3be8c;">__main__</span><span>&#39;:
</span><span>    model_path = &quot;</span><span style="color:#a3be8c;">./chatglm2-6b-int4/</span><span>&quot;
</span><span>    tokenizer = AutoTokenizer.</span><span style="color:#bf616a;">from_pretrained</span><span>(&quot;</span><span style="color:#a3be8c;">THUDM/chatglm2-6b</span><span>&quot;, </span><span style="color:#bf616a;">trust_remote_code</span><span>=</span><span style="color:#d08770;">True</span><span>)
</span><span>    model = AutoModel.</span><span style="color:#bf616a;">from_pretrained</span><span>(model_path, </span><span style="color:#bf616a;">trust_remote_code</span><span>=</span><span style="color:#d08770;">True</span><span>).</span><span style="color:#bf616a;">cuda</span><span>()
</span><span>
</span><span>    </span><span style="color:#a7adba;"># Â§öÊòæÂç°ÊîØÊåÅÔºå‰ΩøÁî®‰∏ãÈù¢‰∏âË°å‰ª£Êõø‰∏äÈù¢‰∏§Ë°åÔºåÂ∞Ünum_gpusÊîπ‰∏∫‰Ω†ÂÆûÈôÖÁöÑÊòæÂç°Êï∞Èáè
</span><span>    </span><span style="color:#a7adba;"># model_path = &quot;THUDM/chatglm2-6b&quot;
</span><span>    </span><span style="color:#a7adba;"># tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=True)
</span><span>    </span><span style="color:#a7adba;"># model = load_model_on_gpus(model_path, num_gpus=2)
</span><span>    model.</span><span style="color:#bf616a;">eval</span><span>()
</span><span>    uvicorn.</span><span style="color:#bf616a;">run</span><span>(app, </span><span style="color:#bf616a;">host</span><span>=&#39;</span><span style="color:#a3be8c;">0.0.0.0</span><span>&#39;, </span><span style="color:#bf616a;">port</span><span>=</span><span style="color:#d08770;">8000</span><span>, </span><span style="color:#bf616a;">workers</span><span>=</span><span style="color:#d08770;">1</span><span>)
</span></code></pre>
<ul>
<li>langchain‰∏≠‰ΩøÁî®chatglm</li>
</ul>
<pre data-lang="Python" style="background-color:#eff1f5;color:#4f5b66;" class="language-Python "><code class="language-Python" data-lang="Python"><span style="color:#b48ead;">from </span><span>langchain.llms </span><span style="color:#b48ead;">import </span><span>ChatGLM
</span><span style="color:#b48ead;">from </span><span>langchain </span><span style="color:#b48ead;">import </span><span>PromptTemplate, LLMChain
</span><span>
</span><span>template = &quot;&quot;&quot;</span><span style="color:#d08770;">{question}</span><span>&quot;&quot;&quot;
</span><span>prompt = </span><span style="color:#bf616a;">PromptTemplate</span><span>(</span><span style="color:#bf616a;">template</span><span>=template, </span><span style="color:#bf616a;">input_variables</span><span>=[&quot;</span><span style="color:#a3be8c;">question</span><span>&quot;])
</span><span style="color:#a7adba;"># ChatGLM api server
</span><span>endpoint_url = &quot;</span><span style="color:#a3be8c;">http://127.0.0.1:8000/</span><span>&quot;
</span><span>
</span><span>llm = </span><span style="color:#bf616a;">ChatGLM</span><span>(
</span><span>    </span><span style="color:#bf616a;">endpoint_url</span><span>=endpoint_url,
</span><span>    </span><span style="color:#bf616a;">max_token</span><span>=</span><span style="color:#d08770;">80000</span><span>,
</span><span>    </span><span style="color:#bf616a;">history</span><span>=[[&quot;</span><span style="color:#a3be8c;">ÊàëÂ∞Ü‰ªéÁæéÂõΩÂà∞‰∏≠ÂõΩÊù•ÊóÖÊ∏∏ÔºåÂá∫Ë°åÂâçÂ∏åÊúõ‰∫ÜËß£‰∏≠ÂõΩÁöÑÂüéÂ∏Ç</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">Ê¨¢ËøéÈóÆÊàë‰ªª‰ΩïÈóÆÈ¢ò„ÄÇ</span><span>&quot;]],
</span><span>    </span><span style="color:#bf616a;">top_p</span><span>=</span><span style="color:#d08770;">0.9</span><span>,
</span><span>    </span><span style="color:#bf616a;">model_kwargs</span><span>={&quot;</span><span style="color:#a3be8c;">sample_model_args</span><span>&quot;: </span><span style="color:#d08770;">False</span><span>},
</span><span>)
</span><span>
</span><span>llm_chain = </span><span style="color:#bf616a;">LLMChain</span><span>(</span><span style="color:#bf616a;">prompt</span><span>=prompt, </span><span style="color:#bf616a;">llm</span><span>=llm)
</span><span>question = &quot;</span><span style="color:#a3be8c;">Âåó‰∫¨Âíå‰∏äÊµ∑‰∏§Â∫ßÂüéÂ∏ÇÊúâ‰ªÄ‰πà‰∏çÂêåÔºü</span><span>&quot;
</span><span>
</span><span style="color:#96b5b4;">print</span><span>(llm_chain.</span><span style="color:#bf616a;">run</span><span>(question))
</span></code></pre>
<ul>
<li>ÊúÄÂêéËøêË°åÂç≥ÂèØ</li>
</ul>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Ê∏ÖÁ©∫‰æßËæπÊ†èÁõÆÂΩïÂàóË°®
            var headings = $('#toc').empty();
            var count = 0;
            $(document.body).find("h1, h2, h3, h4, h5, h6").each(function() {
                var title = $(this).text();
                var id = $(this).attr('id');
                var listItem = '<li><a href="#' + id + '">' + title + '</a></li>';
                
                if (count >= 1) {
                    headings.append(listItem);
                }
                count++; // Â¢ûÂä†ËÆ°Êï∞Âô®
            });

            // Â¶ÇÊûúÁõÆÂΩïÂàóË°®‰∏∫Á©∫ÔºåÂàô‰∏çÊòæÁ§∫‰æßËæπÊ†è
            if (headings.is(':empty')) {
                $('#sidebar').hide(); // ÈöêËóè‰æßËæπÊ†è
            } else {
                // Â¶ÇÊûúÁõÆÂΩï‰∏ç‰∏∫Á©∫ÔºåÊ∑ªÂä†ÁõÆÂΩïÊ†áÈ¢òÂπ∂ÊòæÁ§∫‰æßËæπÊ†è
                headings.prepend('<h2>ÊñáÁ´†ÁõÆÂΩï</h2>');
                $('#sidebar').show(); // ÊòæÁ§∫‰æßËæπÊ†è
            }
        });
    </script>

    

                </div>
            </div>

            <div id="gitalk-container"></div>
            <script>    
            const gitalk = new Gitalk({
              clientID: 'f73599b3b06fe641455a', //'GitHub Application Client ID',
              clientSecret: '99686ea14b4603409e0c159cfd4fad2afd87a1a5', //'GitHub Application Client Secret',
              repo: 'King-Key.github.io',  //'GitHub repo',      // The repository of store comments,
              owner: 'King-Key', //'GitHub repo owner',
              admin: ['King-Key'], //['GitHub repo owner and collaborators, only these guys can initialize github issues'],
              id: location.pathname,      // Ensure uniqueness and length less than 50
              distractionFreeMode: false  // Facebook-like distraction free mode
            })
            gitalk.render('gitalk-container')
            </script>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://king-key.github.io/Blog/2023/Q3/"><</a>
    

            </div>

            <div class="next-link">
                
    
        
        
        
        
            
            
            
        
            
            
            
        
            
            
            
        
            
            
            
        
    

            </div>

        </div>
        
        
            
            <script type="text/javascript" src="https://king-key.github.io/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://king-key.github.io/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://king-key.github.io/book.js"></script>
        

    </body>

</html>
